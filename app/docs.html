<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Documentation - AIDriver</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />

    <!-- Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- GitHub Markdown CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.0/github-markdown-dark.min.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link href="css/style.css?v=2" rel="stylesheet" />
    <style>
      .markdown-body {
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 2rem 3rem;
        background-color: #0d1117;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 1rem;
        }
      }

      .markdown-body img {
        max-width: 100%;
        height: auto;
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
      }

      /* GitHub-style callouts/alerts */
      .markdown-body blockquote {
        padding: 0.5rem 1rem;
        margin: 0 0 1rem 0;
        border-left: 0.25rem solid #30363d;
        background-color: #161b22;
      }

      .markdown-body blockquote p:last-child {
        margin-bottom: 0;
      }

      /* Style for [!Important] callouts */
      .markdown-body blockquote:has(strong:first-child) {
        border-left-color: #a371f7;
      }

      /* Card fills the width */
      .doc-card {
        min-height: calc(100vh - 120px);
      }

      /* Improved code styling */
      .markdown-body code {
        background-color: #1e2836;
        color: #e6db74;
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 0.9em;
      }

      .markdown-body pre {
        background-color: #1a1f2e;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 1rem 1.25rem;
        overflow-x: auto;
        margin: 1rem 0;
      }

      .markdown-body pre code {
        background-color: transparent;
        color: #c9d1d9;
        padding: 0;
        font-size: 0.875rem;
        line-height: 1.6;
      }

      /* Syntax highlighting colors */
      .markdown-body pre code .keyword {
        color: #ff79c6;
      }

      .markdown-body pre code .string {
        color: #a5d6ff;
      }

      .markdown-body pre code .comment {
        color: #8b949e;
        font-style: italic;
      }

      .markdown-body pre code .function {
        color: #d2a8ff;
      }

      .markdown-body pre code .number {
        color: #79c0ff;
      }

      /* Inline code in text */
      .markdown-body p code,
      .markdown-body li code,
      .markdown-body td code {
        background-color: #262d3d;
        color: #f8a4d0;
        border: 1px solid #3d4556;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="bg-dark">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <i class="bi bi-robot me-2"></i>AIDriver
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <!-- Challenge Docs Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="challengeDocsDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-book me-1"></i>Challenge Docs
              </a>
              <ul class="dropdown-menu" aria-labelledby="challengeDocsDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="docs.html?doc=Assembly_Instructions"
                  >
                    <i class="bi bi-tools me-2"></i>Build Instructions
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_0">
                    <i class="bi bi-wrench me-2"></i>Challenge 0: Fix the Code
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_1">
                    <i class="bi bi-arrow-up me-2"></i>Challenge 1: Straight
                    Line
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_2">
                    <i class="bi bi-circle me-2"></i>Challenge 2: Drive a Circle
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_3">
                    <i class="bi bi-rulers me-2"></i>Challenge 3: Distance
                    Sensor
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_4">
                    <i class="bi bi-square me-2"></i>Challenge 4: Drive a Square
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_5">
                    <i class="bi bi-exclamation-triangle me-2"></i>Challenge 5:
                    Obstacle Avoidance
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_6">
                    <i class="bi bi-signpost-split me-2"></i>Challenge 6: Maze
                    Navigation
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_7">
                    <i class="bi bi-controller me-2"></i>Challenge 7: Gamepad
                    Control
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Common_Errors">
                    <i class="bi bi-bug me-2"></i>Common Errors
                  </a>
                </li>
              </ul>
            </li>

            <!-- Challenge Simulator Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="simulatorDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-play-circle me-1"></i>Challenge Simulator
              </a>
              <ul class="dropdown-menu" aria-labelledby="simulatorDropdown">
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=0">
                    <i class="bi bi-wrench me-2"></i>Challenge 0: Fix the Code
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=1">
                    <i class="bi bi-arrow-up me-2"></i>Challenge 1: Straight
                    Line
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=2">
                    <i class="bi bi-circle me-2"></i>Challenge 2: Drive a Circle
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=3">
                    <i class="bi bi-rulers me-2"></i>Challenge 3: Distance
                    Sensor
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=4">
                    <i class="bi bi-square me-2"></i>Challenge 4: Drive a Square
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=5">
                    <i class="bi bi-exclamation-triangle me-2"></i>Challenge 5:
                    Obstacle Avoidance
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=6">
                    <i class="bi bi-signpost-split me-2"></i>Challenge 6: Maze
                    Navigation
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="simulator.html?challenge=7">
                    <i class="bi bi-controller me-2"></i>Challenge 7: Gamepad
                    Control
                  </a>
                </li>
              </ul>
            </li>

            <!-- Downloads Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="downloadsDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-download me-1"></i>Downloads
              </a>
              <ul class="dropdown-menu" aria-labelledby="downloadsDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="_Firmware/AI_Driver_RP2040.uf2"
                    download
                  >
                    <i class="bi bi-cpu me-2"></i>AIDriver Custom Firmware
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="_Firmware/PiPico_Firmware/RPI_PICO-20250415-v1.25.0.uf2"
                    download
                  >
                    <i class="bi bi-motherboard me-2"></i>RP2040 Firmware
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="_Firmware/Brick_recovery/pico_nuke_pico-1.4.uf2"
                    download
                  >
                    <i class="bi bi-trash me-2"></i>Wipe RP2040 Firmware
                  </a>
                </li>
              </ul>
            </li>

            <!-- MicroPython Lab -->
            <li class="nav-item">
              <a
                class="nav-link"
                href="https://lab-micropython.arduino.cc/"
                target="_blank"
              >
                <i class="bi bi-code-square me-1"></i>MicroPython Lab
              </a>
            </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="simulator.html">
                <i class="bi bi-question-circle me-1"></i>Help
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
      <div class="row">
        <!-- Documentation Content -->
        <div class="col-12">
          <div class="card bg-dark border-secondary doc-card">
            <div class="card-body p-0">
              <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <article
                id="markdownContent"
                class="markdown-body"
                style="display: none"
              ></article>
              <div
                id="errorMessage"
                class="alert alert-danger m-4"
                style="display: none"
              >
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="errorText">Failed to load documentation.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <script>
      // GitHub raw content base URL
      const GITHUB_RAW_BASE =
        "https://raw.githubusercontent.com/TempeHS/AIDriver_MicroPython_Challanges/main/docs/";
      const GITHUB_IMAGES_BASE =
        "https://raw.githubusercontent.com/TempeHS/AIDriver_MicroPython_Challanges/main/docs/images/";

      // Configure marked
      marked.setOptions({
        gfm: true,
        breaks: true,
        headerIds: true,
      });

      // Get the document name from URL parameters
      function getDocFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("doc") || "Assembly_Instructions";
      }

      // Fix image URLs in markdown to point to GitHub
      function fixImageUrls(html) {
        // Replace relative image paths with GitHub raw URLs
        return html
          .replace(/src="images\//g, `src="${GITHUB_IMAGES_BASE}`)
          .replace(/src="\.\/images\//g, `src="${GITHUB_IMAGES_BASE}`);
      }

      // Load and render markdown
      async function loadMarkdown(docName) {
        const spinner = document.getElementById("loadingSpinner");
        const content = document.getElementById("markdownContent");
        const errorDiv = document.getElementById("errorMessage");
        const errorText = document.getElementById("errorText");

        // Show loading state
        spinner.style.display = "flex";
        content.style.display = "none";
        errorDiv.style.display = "none";

        try {
          const url = `${GITHUB_RAW_BASE}${docName}.md`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          let markdown = await response.text();

          // Parse markdown to HTML
          let html = marked.parse(markdown);

          // Fix image URLs
          html = fixImageUrls(html);

          // Sanitize HTML
          html = DOMPurify.sanitize(html, {
            ADD_TAGS: ["img"],
            ADD_ATTR: ["src", "alt", "title"],
          });

          // Display content
          content.innerHTML = html;
          content.style.display = "block";
          spinner.style.display = "none";

          // Update page title
          const docTitle = docName.replace(/_/g, " ");
          document.title = `${docTitle} - AIDriver`;
        } catch (error) {
          console.error("Failed to load documentation:", error);
          spinner.style.display = "none";
          errorDiv.style.display = "block";
          errorText.textContent = `Failed to load documentation: ${error.message}`;
        }
      }

      // Handle navigation without page reload
      document
        .querySelectorAll('.dropdown-menu .dropdown-item[href^="docs.html"]')
        .forEach((link) => {
          link.addEventListener("click", (e) => {
            const href = link.getAttribute("href");
            if (href && href.startsWith("docs.html?doc=")) {
              e.preventDefault();
              const docName = new URLSearchParams(href.split("?")[1]).get(
                "doc"
              );
              if (docName) {
                window.history.pushState({}, "", href);
                loadMarkdown(docName);
              }
            }
          });
        });

      // Handle browser back/forward
      window.addEventListener("popstate", () => {
        loadMarkdown(getDocFromUrl());
      });

      // Initial load
      document.addEventListener("DOMContentLoaded", () => {
        loadMarkdown(getDocFromUrl());
      });
    </script>
  </body>
</html>
