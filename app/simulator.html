<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIDriver Simulator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />

    <!-- Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link href="css/style.css?v=4" rel="stylesheet" />
  </head>
  <body class="bg-dark">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <i class="bi bi-robot me-2"></i>AIDriver
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <!-- Challenge Docs Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="challengeDocsDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-book me-1"></i>Challenge Docs
              </a>
              <ul class="dropdown-menu" aria-labelledby="challengeDocsDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="docs.html?doc=Assembly_Instructions"
                  >
                    <i class="bi bi-tools me-2"></i>Build Instructions
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_0">
                    <i class="bi bi-wrench me-2"></i>Challenge 0: Fix the Code
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_1">
                    <i class="bi bi-arrow-up me-2"></i>Challenge 1: Straight
                    Line
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_2">
                    <i class="bi bi-circle me-2"></i>Challenge 2: Drive a Circle
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_3">
                    <i class="bi bi-rulers me-2"></i>Challenge 3: Distance
                    Sensor
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_4">
                    <i class="bi bi-square me-2"></i>Challenge 4: Drive a Square
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_5">
                    <i class="bi bi-exclamation-triangle me-2"></i>Challenge 5:
                    Obstacle Avoidance
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_6">
                    <i class="bi bi-signpost-split me-2"></i>Challenge 6: Maze
                    Navigation
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Challenge_7">
                    <i class="bi bi-controller me-2"></i>Challenge 7: Gamepad
                    Control
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="docs.html?doc=Common_Errors">
                    <i class="bi bi-bug me-2"></i>Common Errors
                  </a>
                </li>
              </ul>
            </li>

            <!-- Challenge Simulator Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="challengeDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-play-circle me-1"></i>Challenge Simulator
              </a>
              <!-- Menu populated dynamically from Challenges.populateMenu() -->
              <ul
                class="dropdown-menu"
                id="challengeSimulatorMenu"
                aria-labelledby="challengeDropdown"
              ></ul>
            </li>

            <!-- Maze Selector (hidden by default, shown for Challenge 6) -->
            <li class="nav-item dropdown d-none" id="mazeSelector">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="mazeDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-grid-3x3 me-1"></i>Select Maze
              </a>
              <ul class="dropdown-menu">
                <li><h6 class="dropdown-header">Easy</h6></li>
                <li>
                  <a class="dropdown-item" href="#" data-maze="simple"
                    >Simple Corridor</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-maze="zigzag"
                    >Zigzag Path</a
                  >
                </li>
                <li><h6 class="dropdown-header">Medium</h6></li>
                <li>
                  <a class="dropdown-item" href="#" data-maze="spiral"
                    >Spiral</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-maze="classic"
                    >Classic Maze</a
                  >
                </li>
                <li><h6 class="dropdown-header">Hard</h6></li>
                <li>
                  <a class="dropdown-item" href="#" data-maze="obstacles"
                    >Obstacle Course</a
                  >
                </li>
              </ul>
            </li>

            <!-- Downloads Dropdown -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="downloadsDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-download me-1"></i>Downloads
              </a>
              <ul class="dropdown-menu" aria-labelledby="downloadsDropdown">
                <li>
                  <a
                    class="dropdown-item"
                    href="_Firmware/AI_Driver_RP2040.uf2"
                    download
                  >
                    <i class="bi bi-cpu me-2"></i>AIDriver Custom Firmware
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="_Firmware/PiPico_Firmware/RPI_PICO-20250415-v1.25.0.uf2"
                    download
                  >
                    <i class="bi bi-motherboard me-2"></i>RP2040 Firmware
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="_Firmware/Brick_recovery/pico_nuke_pico-1.4.uf2"
                    download
                  >
                    <i class="bi bi-trash me-2"></i>Wipe RP2040 Firmware
                  </a>
                </li>
              </ul>
            </li>

            <!-- MicroPython Lab -->
            <li class="nav-item">
              <a
                class="nav-link"
                href="https://lab-micropython.arduino.cc/"
                target="_blank"
              >
                <i class="bi bi-code-square me-1"></i>MicroPython Lab
              </a>
            </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item">
              <a
                class="nav-link"
                href="#"
                data-bs-toggle="offcanvas"
                data-bs-target="#helpPanel"
              >
                <i class="bi bi-question-circle me-1"></i>Help
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-3">
      <div class="row g-3">
        <!-- Left Column: Code Editor -->
        <div class="col-lg-7">
          <div class="card bg-dark border-secondary" id="editorCard">
            <div
              class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
            >
              <span><i class="bi bi-code-slash me-2"></i>Python Code</span>
              <div class="btn-group btn-group-sm">
                <button
                  class="btn btn-outline-light"
                  id="btnCopyCode"
                  data-bs-toggle="tooltip"
                  title="Copy code to clipboard"
                >
                  <i class="bi bi-clipboard"></i>
                </button>
                <button
                  class="btn btn-outline-light"
                  id="btnResetCode"
                  data-bs-toggle="tooltip"
                  title="Reset to starter code"
                >
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="editor"># Loading editor...</div>
            </div>
          </div>

          <!-- Debug Panel (under editor, expands when running) -->
          <div id="debugPanelContainer" class="mt-3">
            <div class="card bg-dark border-secondary">
              <div
                class="card-header bg-secondary text-white py-2 d-flex justify-content-between align-items-center"
              >
                <span> <i class="bi bi-terminal me-2"></i>Debug Output </span>
                <button class="btn btn-sm btn-outline-light" id="btnClearDebug">
                  <i class="bi bi-trash"></i> Clear
                </button>
              </div>
              <div class="card-body p-0">
                <pre id="debugConsole" class="debug-console mb-0">
[AIDriver] Simulator ready
[AIDriver] Select a challenge to begin</pre
                >
              </div>
            </div>
          </div>

          <!-- Gamepad (hidden by default, shown for Challenge 7) -->
          <div
            class="card bg-dark border-secondary mt-3 d-none"
            id="gamepadPanel"
          >
            <div class="card-header bg-secondary text-white py-2">
              <i class="bi bi-controller me-2"></i>Gamepad Control
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-center">
                <div class="gamepad-container">
                  <div class="row g-1 justify-content-center">
                    <div class="col-auto">
                      <button
                        class="btn btn-outline-light btn-lg gamepad-btn"
                        id="btnUp"
                      >
                        <i class="bi bi-chevron-up"></i>
                      </button>
                    </div>
                  </div>
                  <div class="row g-1 justify-content-center">
                    <div class="col-auto">
                      <button
                        class="btn btn-outline-light btn-lg gamepad-btn"
                        id="btnLeft"
                      >
                        <i class="bi bi-chevron-left"></i>
                      </button>
                    </div>
                    <div class="col-auto">
                      <button
                        class="btn btn-secondary btn-lg gamepad-btn"
                        disabled
                      >
                        <i class="bi bi-circle"></i>
                      </button>
                    </div>
                    <div class="col-auto">
                      <button
                        class="btn btn-outline-light btn-lg gamepad-btn"
                        id="btnRight"
                      >
                        <i class="bi bi-chevron-right"></i>
                      </button>
                    </div>
                  </div>
                  <div class="row g-1 justify-content-center">
                    <div class="col-auto">
                      <button
                        class="btn btn-outline-light btn-lg gamepad-btn"
                        id="btnDown"
                      >
                        <i class="bi bi-chevron-down"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Arena & Controls -->
        <div class="col-lg-5">
          <!-- Control Bar -->
          <div class="card bg-dark border-secondary mb-3">
            <div class="card-body py-2">
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <!-- Run/Stop/Step Controls -->
                <div class="btn-group">
                  <button
                    class="btn btn-success"
                    id="btnRun"
                    data-bs-toggle="tooltip"
                    title="Run code"
                  >
                    <i class="bi bi-play-fill"></i> Run
                  </button>
                  <button
                    class="btn btn-danger"
                    id="btnStop"
                    disabled
                    data-bs-toggle="tooltip"
                    title="Stop execution"
                  >
                    <i class="bi bi-stop-fill"></i> Stop
                  </button>
                  <button
                    class="btn btn-info"
                    id="btnStep"
                    data-bs-toggle="tooltip"
                    title="Step through code"
                  >
                    <i class="bi bi-skip-forward-fill"></i> Step
                  </button>
                </div>

                <button
                  class="btn btn-warning"
                  id="btnReset"
                  data-bs-toggle="tooltip"
                  title="Reset robot position"
                >
                  <i class="bi bi-arrow-repeat"></i> Reset
                </button>

                <!-- Speed Slider -->
                <div class="d-flex align-items-center flex-grow-1 ms-2">
                  <label class="text-light me-2 text-nowrap" for="speedSlider">
                    <i class="bi bi-speedometer2"></i>
                  </label>
                  <input
                    type="range"
                    class="form-range"
                    id="speedSlider"
                    min="1"
                    max="5"
                    value="2"
                  />
                  <span class="badge bg-primary ms-2" id="speedValue">2x</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Arena Canvas -->
          <div class="card bg-dark border-secondary mb-3">
            <div
              class="card-header bg-secondary text-white d-flex justify-content-between align-items-center py-2"
            >
              <span
                ><i class="bi bi-grid-3x3-gap me-2"></i>Arena
                (2000×2000mm)</span
              >
              <div class="d-flex align-items-center gap-3">
                <!-- Rotate Car Button -->
                <div class="d-flex align-items-center">
                  <button
                    class="btn btn-sm btn-outline-light"
                    id="btnRotateCar"
                    data-bs-toggle="tooltip"
                    title="Rotate car start direction by 90°"
                  >
                    <i class="bi bi-arrow-clockwise"></i>
                    <span id="rotationDisplay" class="ms-1">0°</span>
                  </button>
                </div>
                <!-- Ultrasonic Distance Display -->
                <div class="d-flex align-items-center">
                  <i class="bi bi-broadcast text-info me-2"></i>
                  <span class="badge bg-info" id="ultrasonicDisplay"
                    >Distance: --- mm</span
                  >
                </div>
              </div>
            </div>
            <div class="card-body p-2">
              <div id="canvasContainer" class="arena-container">
                <canvas id="arenaCanvas"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="fixed-bottom">
      <div
        id="statusBar"
        class="alert alert-info mb-0 rounded-0 py-2 d-flex align-items-center"
      >
        <i class="bi bi-info-circle me-2"></i>
        <span id="statusMessage"
          >Ready - Select a challenge from the dropdown to begin</span
        >
        <span class="ms-auto badge bg-secondary" id="challengeStatus"
          >Not Started</span
        >
      </div>
    </div>

    <!-- Help Offcanvas Panel -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="helpPanel">
      <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title">
          <i class="bi bi-question-circle me-2"></i>Help & Reference
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <h6>AIDriver Methods</h6>
        <div class="list-group list-group-flush mb-3">
          <div class="list-group-item">
            <code>drive_forward(right_speed, left_speed)</code>
            <small class="text-muted d-block"
              >Drive forward with specified wheel speeds (0-255)</small
            >
          </div>
          <div class="list-group-item">
            <code>drive_backward(right_speed, left_speed)</code>
            <small class="text-muted d-block"
              >Drive backward with specified wheel speeds (0-255)</small
            >
          </div>
          <div class="list-group-item">
            <code>rotate_left(turn_speed)</code>
            <small class="text-muted d-block"
              >Rotate counter-clockwise on the spot</small
            >
          </div>
          <div class="list-group-item">
            <code>rotate_right(turn_speed)</code>
            <small class="text-muted d-block"
              >Rotate clockwise on the spot</small
            >
          </div>
          <div class="list-group-item">
            <code>brake()</code>
            <small class="text-muted d-block">Stop both motors</small>
          </div>
          <div class="list-group-item">
            <code>read_distance()</code>
            <small class="text-muted d-block"
              >Read ultrasonic sensor (returns mm, or -1 if invalid)</small
            >
          </div>
        </div>

        <h6>Helper Functions</h6>
        <div class="list-group list-group-flush mb-3">
          <div class="list-group-item">
            <code>hold_state(seconds)</code>
            <small class="text-muted d-block"
              >Pause for specified seconds while logging</small
            >
          </div>
        </div>

        <h6>Speed Guidelines</h6>
        <ul class="small">
          <li><strong>0-80:</strong> Stopped (too slow to move)</li>
          <li><strong>81-120:</strong> Very slow</li>
          <li><strong>121-180:</strong> Slow</li>
          <li><strong>181-220:</strong> Normal</li>
          <li><strong>221-255:</strong> Very fast</li>
        </ul>

        <h6>Keyboard Shortcuts</h6>
        <ul class="small">
          <li><kbd>Ctrl</kbd>+<kbd>Enter</kbd> - Run code</li>
          <li><kbd>Ctrl</kbd>+<kbd>.</kbd> - Stop execution</li>
          <li><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>R</kbd> - Reset robot</li>
        </ul>
      </div>
    </div>

    <!-- Reset Code Confirmation Modal -->
    <div class="modal fade" id="resetCodeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-exclamation-triangle text-warning me-2"></i>Reset
              Code?
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              This will replace your current code with the starter code for this
              challenge.
            </p>
            <p class="text-danger">
              <strong>Any unsaved changes will be lost!</strong>
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-warning" id="btnConfirmReset">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Code
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner (shown during initialization) -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-light mt-3">Initializing simulator...</p>
    </div>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ACE Editor -->
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/ace.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/mode-python.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/theme-monokai.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/ext-language_tools.js"></script>

    <!-- Skulpt Python Interpreter -->
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

    <!-- Application Scripts (order matters!) -->
    <script src="js/debug-panel.js?v=10"></script>
    <script src="js/validator.js?v=13"></script>
    <script src="js/simulator.js?v=10"></script>
    <script src="js/challenges.js?v=13"></script>
    <script src="js/mazes.js?v=25"></script>
    <script src="js/gamepad.js?v=10"></script>
    <script src="js/aidriver-stub.js?v=10"></script>
    <script src="js/python-runner.js?v=43"></script>
    <script src="js/editor.js?v=13"></script>
    <script src="js/app.js?v=48"></script>
  </body>
</html>
